
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pedidos - DistriCarnes Admin</title>
    <link rel="icon" type="image/x-icon" href="../assets/icon/image-removebg-preview sin fondo (1).ico">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #000000 0%, #000000 100%);
            color: #ffffff;
            overflow-x: hidden;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, #000000 0%, #000000 100%);
            padding: 20px;
            z-index: 1000;
            box-shadow: 4px 0 15px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }

        .sidebar::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }

        .sidebar.collapsed {
            transform: translateX(-240px);
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .logo img {
            width: 100%;
            height: 50%;
            margin-right: 15px;
        }

        .logo h2 {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

                .nav-link span {

                    white-space: nowrap;

                    overflow: hidden;

                    text-overflow: ellipsis;

                }

                

                .nav-link:hover,

                .nav-link.active {
            background: #ff0000;
            color: white;
            transform: translateX(5px);
        }

        .nav-link i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }

        .main-content {
            margin-left: 280px;
            padding: 20px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 40px;
        }

        .header {
            background: rgb(0, 0, 0);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            margin-right: 20px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .menu-toggle:hover {
            background: rgba(255,255,255,0.1);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(45deg, #ff0000, #ff0000);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff0000, #ff0000);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 0, 0, 0.4);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-card h3 {
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }

        .stat-card .change {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .change.positive {
            color: #48bb78;
        }

        .change.negative {
            color: #ff0000;
        }

        .icon.pending {
            background: rgba(237, 137, 54, 0.2);
            color: #ed8936;
        }

        .icon.processing {
            background: rgba(66, 153, 225, 0.2);
            color: #4299e1;
        }

        .icon.completed {
            background: rgba(72, 187, 120, 0.2);
            color: #48bb78;
        }

        .icon.cancelled {
            background: rgba(245, 101, 101, 0.2);
            color: #f56565;
        }

        .search-filter-bar {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 45px 12px 15px;
            border-radius: 25px;
            color: white;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #ff0000;
            background: rgba(255,255,255,0.15);
        }

        .search-box input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255,255,255,0.6);
        }

        .filter-select {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 15px;
            border-radius: 8px;
            color: white;
            min-width: 150px;
        }

        .filter-select option {
            background: #2d2d2d;
            color: white;
        }

        .orders-table {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .table-header {
            background: rgba(197, 48, 48, 0.2);
            padding: 20px;
            display: grid;
            grid-template-columns: 100px 1fr 150px 120px 120px 150px 120px;
            gap: 20px;
            align-items: center;
            font-weight: 600;
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .table-row {
            padding: 20px;
            display: grid;
            grid-template-columns: 100px 1fr 150px 120px 120px 150px 120px;
            gap: 20px;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: background 0.3s ease;
        }

        .table-row:hover {
            background: rgba(255,255,255,0.05);
        }

        .order-id {
            font-weight: 600;
            color: #ff0000;
        }

        .customer-info {
            display: flex;
            flex-direction: column;
        }

        .customer-name {
            font-weight: 500;
            color: white;
            margin-bottom: 4px;
        }

        .customer-email {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.6);
        }

        .order-date {
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }

        .order-total {
            font-weight: 600;
            color: white;
            font-size: 1.1rem;
        }

        .order-items {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }

        .order-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }

        .status-pending {
            background: rgba(237, 137, 54, 0.2);
            color: #ed8936;
            border: 1px solid rgba(255, 0, 0, 0.3); 
        }

        .status-processing {
            background: rgba(66, 153, 225, 0.2);
            color: #4299e1;
            border: 1px solid rgba(66, 153, 225, 0.3);
        }

        .status-completed {
            background: rgba(72, 187, 120, 0.2);
            color: #48bb78;
            border: 1px solid rgba(72, 187, 120, 0.3);
        }

        .status-cancelled {
            background: rgba(245, 101, 101, 0.2);
            color: #f56565;
            border: 1px solid rgba(245, 101, 101, 0.3);
        }

        .order-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
        }

        .btn-view {
            background: rgba(66, 153, 225, 0.2);
            color: #4299e1;
            border: 1px solid rgba(66, 153, 225, 0.3);
        }

        .btn-view:hover {
            background: rgba(66, 153, 225, 0.3);
        }

        .btn-edit {
            background: rgba(237, 137, 54, 0.2);
            color: #ed8936;
            border: 1px solid rgba(237, 137, 54, 0.3);
        }

        .btn-edit:hover {
            background: rgba(237, 137, 54, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255,255,255,0.6);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            display: block;
            color: rgba(255,255,255,0.4);
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: rgba(255,255,255,0.8);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 25px;
        }

        .pagination button {
            padding: 10px 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover {
            background: rgba(255,255,255,0.2);
        }

        .pagination button.active {
            background: #ff0000;
            border-color: #ff0000;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
        }

        .close-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .order-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .detail-section {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
        }

        .detail-section h4 {
            color: #c53030;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .detail-label {
            color: rgba(255,255,255,0.7);
        }

        .detail-value {
            color: white;
            font-weight: 500;
        }

        .order-items-list {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .order-items-list h4 {
            color: #c53030;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            color: white;
            font-weight: 500;
        }

        .item-details {
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
        }

        .item-quantity {
            color: rgba(255,255,255,0.8);
            margin: 0 20px;
        }

        .item-price {
            color: white;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .stats-cards {
                grid-template-columns: 1fr;
            }

            .search-filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: auto;
            }

            .table-header,
            .table-row {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: left;
            }

            .order-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script>
        (function(){
            try {
                var raw = localStorage.getItem('userData') || sessionStorage.getItem('currentSession');
                var data = raw ? JSON.parse(raw) : null;
                var user = data && data.user ? data.user : data;
                if (!user || user.rol !== 'admin') {
                    window.location.href = '../login/login.html';
                }
            } catch(e) {
                window.location.href = '../login/login.html';
            }
        })();
    </script>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="logo">
            <img src="../assets/icon/LOGO-DISTRICARNES.png" alt="DistriCarnes">
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="./admin_dashboard.html" class="nav-link ">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="./admin_users.html" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span>Usuarios</span>
                </a>
            </li>
            <li class="nav-item">
                    <a href="./admin_products.html" class="nav-link">
                    <i class="fas fa-box"></i>
                    <span>Productos</span>
                </a>
            </li>
            <li class="nav-item">
                    <a href="./admin_categories.html" class="nav-link">
                    <i class="fas fa-tags"></i>
                    <span>Categorias</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="./admin_orders.html" class="nav-link active">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Pedidos</span>
                </a>
            </li>   
            <li class="nav-item">
                <a href="./admin_inventory.html" class="nav-link">
                    <i class="fas fa-warehouse"></i>
                    <span>Inventario</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="./admin_reports.html" class="nav-link">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reportes</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="./admin_promotions.html" class="nav-link">
                    <i class="fas fa-percent"></i>
                    <span>Promociones</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="./admin_settings.html" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span>Configuración</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Cerrar Sesión</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Gestión de Pedidos</h1>
            </div>
            
            <div class="header-actions">
                <a href="admin_dashboard.html" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Volver
                </a>
            </div>
        </header>

        <!-- Statistics Cards -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-card-header">
                    <h3>Pedidos Pendientes</h3>
                    <div class="icon pending">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                <div class="value" id="statPending">0</div>
                <div class="change positive">
                    <i class="fas fa-arrow-up"></i>
                    +8% desde ayer
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-card-header">
                    <h3>En Proceso</h3>
                    <div class="icon processing">
                        <i class="fas fa-cog"></i>
                    </div>
                </div>
                <div class="value" id="statProcessing">0</div>
                <div class="change positive">
                    <i class="fas fa-arrow-up"></i>
                    +15% desde ayer
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-card-header">
                    <h3>Completados Hoy</h3>
                    <div class="icon completed">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                <div class="value" id="statCompletedToday">0</div>
                <div class="change positive">
                    <i class="fas fa-arrow-up"></i>
                    +22% desde ayer
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-card-header">
                    <h3>Ventas del Día</h3>
                    <div class="icon completed">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="value" id="statDailySales">$0</div>
                <div class="change positive">
                    <i class="fas fa-arrow-up"></i>
                    +18% desde ayer
                </div>
            </div>
        </div>

        <!-- Search and Filter Bar -->
        <div class="search-filter-bar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Buscar por ID, cliente, email...">
                <i class="fas fa-search"></i>
            </div>
            
            <select class="filter-select" id="statusFilter">
                <option value="">Todos los estados</option>
                <option value="pending">Pendientes</option>
                <option value="processing">En Proceso</option>
                <option value="completed">Completados</option>
                <option value="cancelled">Cancelados</option>
            </select>
            
            <select class="filter-select" id="dateFilter">
                <option value="">Todas las fechas</option>
                <option value="today">Hoy</option>
                <option value="yesterday">Ayer</option>
                <option value="week">Esta semana</option>
                <option value="month">Este mes</option>
            </select>
            
            <select class="filter-select" id="sortFilter">
                <option value="-created_at">Más recientes</option>
                <option value="created_at">Más antiguos</option>
                <option value="-total">Mayor valor</option>
                <option value="total">Menor valor</option>
            </select>
        </div>

        <!-- Orders Table -->
        <div class="orders-table">
            <div class="table-header">
                <div>ID</div>
                <div>Cliente</div>
                <div>Fecha</div>
                <div>Items</div>
                <div>Total</div>
                <div>Entrega</div>
                <div>Estado</div>
                <div>Acciones</div>
            </div>
            <div id="ordersTableRows"></div>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination"></div>
    </main>

    <!-- Order Details Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Detalles del Pedido</h3>
                <button class="close-btn" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="order-details">
                <div class="detail-section">
                    <h4>Información del Cliente</h4>
                    <div class="detail-item">
                        <span class="detail-label">Nombre:</span>
                        <span class="detail-value" id="customerName">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Email:</span>
                        <span class="detail-value" id="customerEmail">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Teléfono:</span>
                        <span class="detail-value" id="customerPhone">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Dirección:</span>
                        <span class="detail-value" id="customerAddress">-</span>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>Información del Pedido</h4>
                    <div class="detail-item">
                        <span class="detail-label">ID:</span>
                        <span class="detail-value" id="orderId">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Fecha:</span>
                        <span class="detail-value" id="orderDate">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Estado:</span>
                        <span class="detail-value" id="orderStatus">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Método de Pago:</span>
                        <span class="detail-value" id="paymentMethod">-</span>
                    </div>
                </div>
            </div>
            
            <div class="order-items-list">
                <h4>Productos del Pedido</h4>
                <div id="orderItemsList">
                    <!-- Items will be loaded here -->
                </div>
            </div>
            
            <div class="detail-section">
                <h4>Resumen de Pago</h4>
                <div class="detail-item">
                    <span class="detail-label">Subtotal:</span>
                    <span class="detail-value" id="orderSubtotal">-</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Envío:</span>
                    <span class="detail-value" id="orderShipping">-</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Impuestos:</span>
                    <span class="detail-value" id="orderTax">-</span>
                </div>
                <div class="detail-item" style="border-top: 2px solid #c53030; padding-top: 15px; margin-top: 15px;">
                    <span class="detail-label"><strong>Total:</strong></span>
                    <span class="detail-value" id="orderTotal" style="color: #c53030; font-size: 1.2rem;">-</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cerrar</button>
                <button type="button" class="btn btn-primary" id="updateStatusBtn" onclick="showStatusUpdate()">Actualizar Estado</button>
            </div>
        </div>
    </div>

    <script>
        // Toggle sidebar
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');

        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        });

        // Mobile sidebar toggle
        if (window.innerWidth <= 768) {
            sidebar.classList.add('collapsed');
            mainContent.classList.add('expanded');
            
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });
        }

        // Estado y filtros (renderizado JS con paginación)
        // Detectar base path para funcionar tanto en /DISTRICARNES como en /
        const BASE_PATH = (function(){
            const parts = window.location.pathname.split('/').filter(Boolean);
            // Si el primer segmento NO es 'admin', úsalo como base (p.ej. 'DISTRICARNES')
            if (parts.length && parts[0] !== 'admin') { return '/' + parts[0]; }
            return '';
        })();
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const dateFilter = document.getElementById('dateFilter');
        const sortFilter = document.getElementById('sortFilter');
        const rowsContainer = document.getElementById('ordersTableRows');
        const paginationEl = document.getElementById('pagination');

        let AdminOrdersCache = [];
        let FilteredOrders = [];
        let CurrentPage = 1;
        const PageSize = 10;

        // Actualizar tarjetas de estadísticas
        function updateStats(){
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const pending = (AdminOrdersCache||[]).filter(o => String(o.status||'').toUpperCase() === 'PENDING').length;
            const processing = (AdminOrdersCache||[]).filter(o => String(o.status||'').toUpperCase() === 'PROCESSING').length;
            const completedToday = (AdminOrdersCache||[]).filter(o => {
                const st = String(o.status||'').toUpperCase();
                const d = new Date(o.created_at);
                return st === 'COMPLETED' && d >= startOfToday;
            }).length;
            const dailySales = (AdminOrdersCache||[]).reduce((sum,o)=>{
                const d = new Date(o.created_at);
                const st = String(o.status||'').toUpperCase();
                if (d >= startOfToday && st === 'COMPLETED') { sum += Number(o.total||0); }
                return sum;
            }, 0);
            const fmt = n => n.toLocaleString('es-CO');
            const $ = id => document.getElementById(id);
            if($('statPending')) $('statPending').textContent = String(pending);
            if($('statProcessing')) $('statProcessing').textContent = String(processing);
            if($('statCompletedToday')) $('statCompletedToday').textContent = String(completedToday);
            if($('statDailySales')) $('statDailySales').textContent = `$${fmt(Number(dailySales||0))}`;
        }

        function applyFiltersSort() {
            const term = (searchInput.value || '').toLowerCase();
            const statusVal = (statusFilter.value || '').toLowerCase();
            const dateVal = dateFilter.value || '';
            const sortVal = sortFilter.value || '-created_at';

            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfYesterday = new Date(startOfToday.getTime() - 24*60*60*1000);
            const startOfWeek = new Date(startOfToday.getTime() - 7*24*60*60*1000);
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            FilteredOrders = (AdminOrdersCache || []).filter(o => {
                const idStr = String(o.id || '').toLowerCase();
                const nameStr = String(o.customer_name || '').toLowerCase();
                const emailStr = String(o.customer_email || '').toLowerCase();
                const statusStr = String(o.status || '').toLowerCase();
                const created = new Date(o.created_at);

                const searchMatch = idStr.includes(term) || nameStr.includes(term) || emailStr.includes(term);
                const statusMatch = !statusVal || statusStr === statusVal;

                let dateMatch = true;
                if (dateVal === 'today') { dateMatch = created >= startOfToday; }
                else if (dateVal === 'yesterday') { dateMatch = created >= startOfYesterday && created < startOfToday; }
                else if (dateVal === 'week') { dateMatch = created >= startOfWeek; }
                else if (dateVal === 'month') { dateMatch = created >= startOfMonth; }

                return searchMatch && statusMatch && dateMatch;
            });

            const dir = sortVal.startsWith('-') ? -1 : 1;
            const key = sortVal.replace('-', '');
            FilteredOrders.sort((a,b) => {
                let va = a[key]; let vb = b[key];
                if (key === 'created_at') { va = new Date(a.created_at).getTime(); vb = new Date(b.created_at).getTime(); }
                if (key === 'total') { va = Number(a.total||0); vb = Number(b.total||0); }
                if (va < vb) return -1 * dir;
                if (va > vb) return 1 * dir;
                return 0;
            });

            renderPage(1);
            updateStats();
        }

        function renderPage(page){
            CurrentPage = page;
            const start = (page-1) * PageSize;
            const end = start + PageSize;
            const items = FilteredOrders.slice(start, end);
            rowsContainer.innerHTML = items.map(order => `
                <div class="table-row" data-order-id="${order.id}">
                    <div class="order-id">#${order.id}</div>
                    <div class="customer-info">
                        <div class="customer-name">${order.customer_name || ''}</div>
                        <div class="customer-email">${order.customer_email || ''}</div>
                    </div>
                    <div class="order-date">${new Date(order.created_at).toLocaleString('es-CO')}</div>
                    <div class="order-items">${Number(order.items_count||0)} items</div>
                    <div class="order-total">$${Number(order.total||0).toLocaleString('es-CO')}</div>
                    <div class="order-delivery">${order.delivery_method === 'punto' ? 'Retiro en punto' : 'Entrega a domicilio'}</div>
                    <div class="order-status status-${(order.status||'').toLowerCase()}">${order.status || ''}</div>
                    <div class="order-actions">
                        <button class="btn btn-sm btn-view" onclick="viewOrder(${order.id})"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-edit" onclick="updateOrderStatus(${order.id})"><i class="fas fa-edit"></i></button>
                    </div>
                </div>
            `).join('');
            renderPagination();
        }

        function renderPagination(){
            const totalPages = Math.max(1, Math.ceil(FilteredOrders.length / PageSize));
            let html = '';
            const prevDisabled = CurrentPage <= 1 ? 'disabled' : '';
            const nextDisabled = CurrentPage >= totalPages ? 'disabled' : '';
            html += `<button ${prevDisabled} onclick="goToPage(${CurrentPage-1})"><i class='fas fa-chevron-left'></i></button>`;
            const windowStart = Math.max(1, CurrentPage - 2);
            const windowEnd = Math.min(totalPages, windowStart + 4);
            for(let p=windowStart; p<=windowEnd; p++){
                html += `<button class="${p===CurrentPage?'active':''}" onclick="goToPage(${p})">${p}</button>`;
            }
            html += `<button ${nextDisabled} onclick="goToPage(${CurrentPage+1})"><i class='fas fa-chevron-right'></i></button>`;
            paginationEl.innerHTML = html;
        }

        function goToPage(p){
            const totalPages = Math.max(1, Math.ceil(FilteredOrders.length / PageSize));
            if(p < 1 || p > totalPages) return;
            renderPage(p);
        }

        async function updateOrderStatus(orderId) {
            const allowed = {
                'pending': 'Pendiente',
                'processing': 'En Proceso',
                'completed': 'Completado',
                'cancelled': 'Cancelado'
            };

            const { value: newStatus } = await Swal.fire({
                title: 'Actualizar Estado del Pedido',
                input: 'select',
                inputOptions: allowed,
                inputPlaceholder: 'Selecciona un estado',
                showCancelButton: true,
                confirmButtonText: 'Actualizar',
                cancelButtonText: 'Cancelar',
                background: '#1a1a1a',
                color: '#ffffff',
                confirmButtonColor: '#ff0000',
                cancelButtonColor: '#6c757d',
            });

            if (!newStatus) {
                return; // User cancelled
            }

            try {
                const response = await fetch(`${BASE_PATH}/backend/php/orders_update_status.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: Number(orderId), status: newStatus })
                });

                const resp = await response.json();

                if (!resp || !resp.ok) {
                    throw new Error(resp.message || 'No se pudo actualizar el estado');
                }

                const idx = AdminOrdersCache.findIndex(o => Number(o.id) === Number(orderId));
                if (idx >= 0) {
                    AdminOrdersCache[idx].status = newStatus;
                }
                
                Swal.fire({
                    icon: 'success',
                    title: '¡Actualizado!',
                    text: 'El estado del pedido ha sido cambiado.',
                    background: '#1a1a1a',
                    color: '#ffffff',
                    timer: 1500,
                    showConfirmButton: false
                });

                applyFiltersSort();
                renderPage(CurrentPage);

            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Error de red al actualizar estado.',
                    background: '#1a1a1a',
                    color: '#ffffff',
                });
            }
        }

        function showStatusUpdate() {
            const orderId = document.getElementById('orderId').textContent.replace('#', '');
            updateOrderStatus(orderId);
        }

        function closeModal() { document.getElementById('orderModal').style.display = 'none'; }
        document.getElementById('orderModal').addEventListener('click', function(e) { if (e.target === this) { closeModal(); } });

        searchInput.addEventListener('input', applyFiltersSort);
        statusFilter.addEventListener('change', applyFiltersSort);
        dateFilter.addEventListener('change', applyFiltersSort);
        sortFilter.addEventListener('change', applyFiltersSort);

        // Modal functions
        // Cache de pedidos cargados
        // (Nota: la variable AdminOrdersCache ya está declarada anteriormente)

        function viewOrder(orderId) {
            const idNum = Number(orderId);
            const order = AdminOrdersCache.find(o => Number(o.id) === idNum);
            if (!order) {
                document.getElementById('orderModal').style.display = 'block';
                return;
            }
            const addr = order.address || {};
            const addrLine = `${addr.street || ''}${addr.city ? ' - ' + addr.city : ''}${addr.dept ? ', ' + addr.dept : ''}`.trim() || '-';
            const subtotal = (order.items || []).reduce((s,i)=> s + Number(i.price||0)*Number(i.qty||0), 0);

            document.getElementById('orderId').textContent = `#${order.id}`;
            document.getElementById('customerName').textContent = order.customer_name || '-';
            document.getElementById('customerEmail').textContent = order.customer_email || '-';
            document.getElementById('customerPhone').textContent = '+57 300 123 4567';
            document.getElementById('customerAddress').textContent = addrLine;
            document.getElementById('orderDate').textContent = new Date(order.created_at).toLocaleString('es-CO');
            document.getElementById('orderStatus').textContent = order.status || '-';
            document.getElementById('paymentMethod').textContent = 'PayPal';
            document.getElementById('orderSubtotal').textContent = `$${subtotal.toLocaleString('es-CO')}`;
            document.getElementById('orderShipping').textContent = '$0';
            document.getElementById('orderTax').textContent = '$0';
            document.getElementById('orderTotal').textContent = `$${Number(order.total||0).toLocaleString('es-CO')}`;

            const itemsList = document.getElementById('orderItemsList');
            itemsList.innerHTML = (order.items||[]).map(i=>`
                <div class="item-row">
                    <div class="item-info">
                        <div class="item-name">${i.title || 'Producto'}</div>
                        <div class="item-details">Precio: $${Number(i.price||0).toLocaleString('es-CO')}</div>
                    </div>
                    <div class="item-quantity">x${Number(i.qty||0)}</div>
                    <div class="item-price">$${(Number(i.price||0)*Number(i.qty||0)).toLocaleString('es-CO')}</div>
                </div>
            `).join('');

            document.getElementById('orderModal').style.display = 'block';
        }

        // (Se eliminan definiciones duplicadas de updateOrderStatus, showStatusUpdate y closeModal)

        // Cargar pedidos del backend y renderizar con filtros/paginación
        (async function loadAdminOrders(){
            try{
                const res = await fetch(`${BASE_PATH}/backend/php/orders_list.php`);
                const data = await res.json();
                if(!data || !data.ok){ rowsContainer.innerHTML = '<div class="empty-state"><h3>Error cargando pedidos</h3></div>'; return; }
                AdminOrdersCache = data.orders || [];
                applyFiltersSort();
                updateStats();
            }catch(e){ console.error('Error cargando pedidos', e); rowsContainer.innerHTML = '<div class="empty-state"><h3>Error cargando pedidos</h3></div>'; }
        })();

        // Actualización en tiempo real (polling)
        const POLL_MS = 15000;
        setInterval(async () => {
            try{
                const res = await fetch(`${BASE_PATH}/backend/php/orders_list.php`);
                const data = await res.json();
                if(data && data.ok){
                    AdminOrdersCache = data.orders || [];
                    applyFiltersSort();
                    updateStats();
                }
            }catch(err){ /* silent */ }
        }, POLL_MS);
    </script>
</body>
<script src="../static/js/session_guard.js" defer></script>
<script src="../static/js/network_guard.js" defer></script>
</html>